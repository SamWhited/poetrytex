% !TEX TS-program = xelatex
% !TEX encoding = UTF-8
% Copyright 2011 Sam Whited <sam@samwhited.com>
% Licensed under the Creative Commons Attribution 3.0 Unported License
% (CC BY 3.0)
% https://creativecommons.org/licenses/by/3.0/

% https://github.com/SamWhited/poetrytex

% This package is designed to work with TeX engines that directly
% process UTF8 input and use Unicode and OpenType fonts.

\ProvidesPackage{poetrytex}

\RequirePackage{parskip}
\RequirePackage{fontspec}
\RequirePackage{multicol}
\RequirePackage[pdfborder=0, bookmarks, colorlinks=false]{hyperref}

% Disable Chapter, Section, and Subsection numbering
\setcounter{secnumdepth}{-1} 
\setlength{\parindent}{0pt}
\setlength{\parskip}{3mm}

% Default to Calluna by exljbris
% This should probably be changed, but I like Calluna...
\newcommand{\defaultfontfamily}[0]{Calluna}

% Allow the use of standard LaTeX mappings such as "---" for em-dashes.
\defaultfontfeatures{Mapping=tex-text, Ligatures=Common}

\setromanfont{\defaultfontfamily}
\newfontfamily\useligatures[Mapping=tex-text, Ligatures={Common, Rare}]{\defaultfontfamily}
\newfontfamily\usediscretionary[Mapping=tex-text, Ligatures={Discretionary, Common, Rare}]{\defaultfontfamily}
\newfontfamily\useordinals[Mapping=tex-text,VerticalPosition=Ordinal]{\defaultfontfamily}
\newcommand{\altern}[1]{{\fontspec{\defaultfontfamily:+salt}#1}}
\font\capital="\defaultfontfamily:+salt" at 18pt
\font\alternsmall="\defaultfontfamily:+salt" at 8pt

\newcommand{\poemtitlefont}{\normalfont\bfseries\large\centering}

\renewcommand{\listtablename}{List of Poems}

\renewcommand{\subsubsection}[1]{
	\vspace{0.3cm}
	\textbf{#1}\\*
	\vspace{0.2cm}
}

\newcommand{\footer}[3]{
	\begin{center}
		{\usediscretionary
			\copyright\ #1 #2\\
			#3
		}
	\end{center}
}

\newcommand{\thegroup}[0]{0000}
\newcounter{poemnum}

\newcommand{\numberpoems}{\def\@numberpoems{}}
\newcommand{\numbertop}{\def\@numbertop{}}
\newcommand{\resetnumongroup}{\def\@resetnumongroup{}}
\newcommand{\hidetopintoc}{\def\@hidetopintoc{}}

\newcommand{\poemgroup}[1]{
	\ifx \@resetnumongroup \@undefined
		\relax
	\else
		\setcounter{poemnum}{0}
	\fi
	\cleardoublepage
	\renewcommand{\thegroup}[0]{#1}
	\vspace*{\fill}
	\pagestyle{empty}
	\begin{center}
		{\usediscretionary
			\section{#1}
			\addcontentsline{lot}{section}{#1}
		}
	\end{center}
	\vspace*{\fill}
	\clearpage
}

\newenvironment{annotation}[1]{
	\cleardoublepage
	\poetryheadings
	\begin{flushleft}
	\subsection{#1}
}
{

	\end{flushleft}
	\clearpage
}

\newenvironment{poem}[2]{
	\poetryheadings
	\addtocounter{poemnum}{1}
	\begin{center}
		\phantomsection
		\addcontentsline{lot}{subsection}{\ifx\@numbertop\@undefined\relax\else\arabic{poemnum}.\ \fi#1}
		% Has smaller margins than \subsection
		{\poemtitlefont \ifx\@numberpoems\@undefined\relax\else\arabic{poemnum}\\\fi#1}\\
		#2
	\end{center}
	\begin{center}
}
{
	\end{center}
	\clearpage
}

\newcommand{\poetryheadings}[0]{
	\pagestyle{myheadings}
	\markboth{ | \MakeUppercase{\thetitle}\hfill }{\hfill\MakeUppercase{\thegroup}\ | }
}

\setcounter{tocdepth}{2}

\def\thetitle{Title}
\def\thesubtitle{Subtitle}
\def\theauthor{Author}
\def\thedate{}
\def\thededication{}

\newcommand{\makededication}[0]{
	\thispagestyle{empty}
	\vspace*{\fill}
	\begin{flushright}
		\emph{\thededication}
	\end{flushright}
	\vspace*{\fill}
}

\newcommand{\maketoc}[0]{
	\tableofcontents
	\pagestyle{plain}
	\clearpage
	\thispagestyle{empty}
}

\newcommand{\maketop}[0]{
	\ifx \@hidetopintoc \@undefined
		\cleardoublepage
		\phantomsection
		\addcontentsline{toc}{section}{\listtablename}
	\fi
	\listoftables
	\pagestyle{plain}
	\clearpage
}

\title{\thetitle\\\thesubtitle}
\author{\theauthor}
\date{\thedate}
