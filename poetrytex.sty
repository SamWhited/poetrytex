% **PoetryTeX** is a TeX package designed to aid in the formatting and typesetting
% of anthologies of poetry and other writings. It was designed to work with any TeX
% engine that supports direct Unicode input and OpenType fonts, specifically XeLaTeX.

%
%### License
%

% PoetryTeX is maintained by [Sam Whited](https://samwhited.com).
%
% The [source for PoetryTeX](https://github.com/SamWhited/poetrytex) is available on [GitHub](https://github.com)
% and released under the Creative Commons Attribution 3.0 License ([CC BY 3.0](https://creativecommons.org/licenses/by/3.0/)).

%
%### Documentation
%

% This documentation was generated from [Markdown](http://daringfireball.net/projects/markdown/)
% embedded in **poetrytex.sty** using [Docco](http://jashkenas.github.com/docco/), a
% literate-programming-style documentation generator.

%
%### Using PoetryTeX
%

% To install PoetryTeX from the command line, first make sure that you have [Git](http://git-scm.com/) installed,
% then navigate to your TeX package directory and run:
%
%     git clone git://github.com/SamWhited/poetrytex.git
%

%
%### Package Setup
%

% Provide the `poetrytex` package to our TeX engine.
% Because PoetryTeX is provided as a package, using it is as easy as calling
% one of the following commands in the preamble of our document:
%
%     \usepackage{poetrytex}
%     \RequirePackage{poetrytex}
%
\ProvidesPackage{poetrytex}

% Make sure our distribution supports everything we need.
\NeedsTeXFormat{LaTeX2e}[1994/06/01]

% Require the `fontspec` and `hyperref` packages.
\RequirePackage{fontspec}
\RequirePackage[pdfborder=0, bookmarks, colorlinks=false]{hyperref}

% Require parskip as a temporary hack until a better solution can be found.
\RequirePackage[parfill]{parskip}

% Disable Chapter, Section, and Subsection numbering.
\setcounter{secnumdepth}{-1}

% Set some defaults for a few basic commands.
% These can be changed by redefining the commands like so:
%
%     \renewcommand*{\pttitle}{My Title}
%
\newcommand*{\pttitle}{Title}
\newcommand*{\ptsubtitle}{Subtitle}
\newcommand*{\ptauthor}{Author}
\newcommand*{\ptdate}{\today}
\newcommand*{\ptdedication}{}

% Set the title, author, and date to the defaults we defined above.
% The other commands are required because `\maketitle` clears `\title`
% and we might want to use it elsewhere (in the page headings, for instance).
\title{\pttitle\ifx\ptsubtitle\@ptundefined\relax\else\\\ptsubtitle\fi}
\author{\ptauthor}
\date{\ptdate}

% Renew the `\subsubsection` command to be centered, and use smaller margins.
\renewcommand*{\subsubsection}{\@ifstar{\@ptsubsubsectionStar}{\@ptsubsubsectionNoStar}}

% Used when `\subsubsection*` is called.
% This version does not create an entry in the ToC.
\newcommand*{\@ptsubsubsectionStar}[1]{%
	\vspace{0.3cm}
	{\centering \textbf{#1}}
	\vspace{0.2cm}
}

% Used when `\subsubsection` is called.
% This version creates an entry in the ToC.
\newcommand*{\@ptsubsubsectionNoStar}[1]{%
	\vspace{0.3cm}
	\phantomsection
	\addcontentsline{toc}{subsubsection}{#1}
	{\centering \textbf{#1}}
	\vspace{0.2cm}
}

% Setup the default document headings and provide a command for inserting them
% on a page. To create your own headings, redefine `\poetryheadings` like so:
%
%	\pagestyle{myheadings}
%	\markboth{ | First heading\hfill }{\hfill Other heading\ | }
%
\newcommand*{\poetryheadings}[0]{%
	\pagestyle{myheadings}
	\markboth{ | \MakeUppercase{\pttitle}\hfill }{\hfill\MakeUppercase{\ptgroup}\ | }
}

% Make a nice dedication page for the document.
\newcommand*{\makededication}[0]{%
	\thispagestyle{empty}
	\vspace*{\fill}
	\begin{flushright}
		\emph{\ptdedication}
	\end{flushright}
	\vspace*{\fill}
}

%
%### Tables and Links
%

% Each poem automatically has a label applied to it so that we can link
% directly to them in footnotes, annotations, etc.
% This label should not conflict with any user defined labels, so provide
% a prefix for the label to make it a bit less likely to collide.
% There is really no reason to ever change this.
\newcommand*{\@ptpoemlabeltext}{poetrytexpoem:}

% Links directly to a poem by number.
% The optional first argument specifies the number of the poem, and the second
% specifies the link text. If no first argument is given, the second is used as both the link
% destination and text.
\newcommand*{\linktopoem}[2][false]{%
	\newcommand*{\@ptfirstarg}{#1}
	\newcommand*{\@ptfalse}{false}
	\ifx \@ptfirstarg \@ptfalse
		\hyperref[\@ptpoemlabeltext#2]{#2}\relax
	\else
		\hyperref[\@ptpoemlabeltext#1]{#2}\relax
	\fi
}

% Make the Table of Contents only display Sections and Subsections.
\setcounter{tocdepth}{2}

% The `\toptitle` command is used to set the table of poems title.
% To change the title everywhere it is used, renew `\toptitle` like so:
%
%	\renewcommand*{\toptitle}{New Title}
%
% If you want to change the actual title on the table of poems, but keep it the same
% elsewhere (in the ToC for instance), you can renew `\listtablename` directly:
%
%	\renewcommand*{\listtablename}{\S\ \toptitle}
%
\newcommand*{\toptitle}{List of Poems}

% Set the title of the table of poems to the default.
\renewcommand*{\listtablename}{\toptitle}

% The type of entry that will be created in the Table of Poems for each `poem` environment.
\newcommand*{\topentrytype}{subsection}

% Make the **Table of Contents** and set the page styles.
\newcommand*{\maketoc}{%
	\tableofcontents
	\pagestyle{plain}
	\clearpage
	\thispagestyle{empty}
}

% Make the **Table of Poems** and add an entry to the ToC if required.
% To hide the ToC entry, simply call `\maketop*`.
\newcommand*{\maketop}{\@ifstar{\@ptmaketopStar}{\@ptmaketopNoStar}}
\newcommand*{\@ptmaketopStar}{%
	\listoftables
	\pagestyle{plain}
	\clearpage
}
\newcommand*{\@ptmaketopNoStar}{%
	\cleardoublepage
	\phantomsection
	\addcontentsline{toc}{section}{\toptitle}
	\listoftables
	\pagestyle{plain}
	\clearpage
}

%
%### Numbering
%

% Create counters that will be used to number each poem.
% By default, `poemnum` and `absolutepoemnum` are the same, however
% if `\resetnumongroup` has been called, the `poemnum` counter will be reset
% each time the group changes, while the `absolutepoemnum` counter will continue
% to increment.
\newcounter{poemnum}
\newcounter{absolutepoemnum}

% Reset the numbering counter when the group changes.
\newcommand*{\resetnumongroup}{\newcommand*{\@ptresetnumongroup}{}}

% Numbers the poems in the Table of Poems.
\newcommand*{\numbertop}{\newcommand*{\@ptnumbertop}{}}

% Create a number above each poem's title.
\newcommand*{\numberpoems}{\newcommand*{\@ptnumberpoems}{}}

%
%### Groups
%

% Collections made with PoetryTeX have the option of grouping poems into sections, or chapters.
% Each of these groups has a title page, and entries in the Table of Contents and Table of Poems.

% Holds the name of the current group. If you want to start a new group, but don't want to
% create a title page, you can renew this command like so: `\renewcommand*{\ptgroup}{Group Name}`
\newcommand*{\ptgroup}{}

% Create a group starting from the current location in the document.
% This creates a title page for the group, and adds lines to the Table of Poems
% and the Table of Contents unless the starred version of the command is called.
\newcommand*{\poemgroup}{%
	\@ifstar{%
		\@ptpoemgroupStar
	}{%
		\@ptpoemgroupNoStar
	}
}

% Internal helper command that is called whenever `\poemgroup*` is called.
\newcommand*{\@ptpoemgroupStar}[1]{%
	\ifx \@ptresetnumongroup \@ptundefined
		\relax
	\else
		\setcounter{poemnum}{0}
	\fi
	\cleardoublepage
	\vspace*{\fill}
	\renewcommand*{\ptgroup}{#1}
	\pagestyle{empty}
	\begin{center}
		\section*{#1}
	\end{center}
	\vspace*{\fill}
	\clearpage
}

% Internal helper command that is called whenever `\poemgroup` is called.
\newcommand*{\@ptpoemgroupNoStar}[1]{%
	\ifx \@ptresetnumongroup \@ptundefined
		\relax
	\else
		\setcounter{poemnum}{0}
	\fi
	\cleardoublepage
	\vspace*{\fill}
	\renewcommand*{\ptgroup}{#1}
	\pagestyle{empty}
	\begin{center}
		\section{#1}
		\addcontentsline{lot}{section}{#1}
	\end{center}
	\vspace*{\fill}
	\clearpage
}

%
%### Fonts
%

% Sets the default font to [Calluna](http://www.exljbris.com/calluna.html), a nice
% typeface by the [exljbris Font Foundry](http://www.exljbris.com/). Calluna is
% easy to read on screen, and looks great in print. Also set the fallback font
% to DejaVu Serif which is common among Linux distros.
\newcommand*{\defaultfontfamily}{Calluna}
\newcommand*{\fallbackfontfamily}{Georgia}

% If Calluna isn't available, fallback to `\fallbackfontfamily`.
\count255=\interactionmode
  \batchmode
  \font\bodyfont="\defaultfontfamily"\space at 10pt
  \ifx\bodyfont\nullfont
    \font\bodyfont = "\fallbackfontfamily"\space at 10pt
    \ifx\bodyfont\nullfont
      \errorstopmode
      \errmessage{Default fonts not found.}
    \else
      \let\defaultfontfamily=\fallbackfontfamily
    \fi
  \fi
\interactionmode=\count255

% Allow the use of standard LaTeX mappings such as "---" for em-dashes.
\defaultfontfeatures{Mapping=tex-text, Ligatures=Common}

% Set the default font to `\defaultfontfamily`.
\setmainfont{\defaultfontfamily}

% Create several new font families to make using ligatures easier.
% Each of these is based on `\defaultfontfamily`.

% `\useligatures` includes Common, and Rare ligatures,
% `\usediscretionary` includes Common, Rare, and Discretionary ligatures,
% `\useordinals` sets the vertical position of characters to Ordinal where available.
\newfontfamily\useligatures[Mapping=tex-text, Ligatures={Common, Rare}]{\defaultfontfamily}
\newfontfamily\usediscretionary[Mapping=tex-text, Ligatures={Discretionary, Common, Rare}]{\defaultfontfamily}
\newfontfamily\useordinals[Mapping=tex-text,VerticalPosition=Ordinal]{\defaultfontfamily}

% Prints the stylistic alternatives for any characters passed in using `\defaultfontfamily:+salt`
\newcommand*{\altern}[1]{{\fontspec{\defaultfontfamily:+salt}#1}}

% Define the font options that should be used for poem titles.
% By default, titles use the `\normalfont`, are bold, large, and centered.
\newcommand*{\poemtitleformat}{\normalfont\bfseries\large\centering}

%
%### Poetry
%

% The two main environments defined by PoetryTeX are the `poem` environment, and the `annotation` environment.
% Both environments clear the page afterwards, and use the `\poetryheadings` command to set the page headings.

% The poem environment takes in a title and a subtitle (or authors name, or date, etc.) and will automatically list the
% poem in the Table of Contents and the List of Poems. By default, it wraps everything in the `verse` environment.
% To change this, you can optionally supply it with the name of another environment.
% For example:
%
%     \begin{poem}[center]{Sonnet CL}
%          % This poem will be centered!
%     \end{poem}
%
\newenvironment{poem}[3][verse]{%
	\newcommand*{\@ptwrapenvironment}{#1}
	\poetryheadings
	\addtocounter{poemnum}{1}
	\addtocounter{absolutepoemnum}{1}
	\begin{center}
		\phantomsection%
		\addcontentsline{lot}{\topentrytype}{\ifx\@ptnumbertop\@ptundefined\relax\else\arabic{poemnum}.\ \fi#2}%
		\label{\@ptpoemlabeltext\arabic{absolutepoemnum}}
		{\poemtitleformat \ifx\@ptnumberpoems\@ptundefined\relax\else\arabic{poemnum}\\\fi#2}\\%
		#3
	\end{center}
	\begin{\@ptwrapenvironment}
	\begingroup\setlength{\parskip}{\stanzaparskip}
}{%
	\endgroup
	\end{\@ptwrapenvironment}
	\ifx \@ptclearpageafterpoem \@ptundefined
		\relax
	\else
		\clearpage
	\fi
}

% The `annotation` environment takes in a title, and is used for providing extra (prose) text.
% Annotations will show up in the Table of Contents, but not in the List of Poems.
\newenvironment{annotation}[1]{%
	\cleardoublepage
	\poetryheadings
	\begin{flushleft}
	\subsection{#1}
}{%

	\end{flushleft}
	\clearpage
}

%
%### Formatting
%

% Below are some basic formatting options. PoetryTeX was mostly designed for formatting an anthology of
% writings, and leaves the formatting of individual poems or stories up to the author, and other packages.
% Most of these options can be found in the `verse` package. However, they are included below in case
% you do not want to override the default `verse` environment or want to use a different package
% for formatting your work.

% Set the length of `\stanzaparskip` outside of the poem environment to change the spacing
% between stanzas. It is set at 0.7em by default.
\newlength{\stanzaparskip}
\setlength{\stanzaparskip}{0.7em}

% Clear the page after each poem.
\newcommand*{\clearpageafterpoem}{\newcommand*{\@ptclearpageafterpoem}{}}

% The length, `\ptgap` is the length to indent lines by. It is set at 2em by default.
\newlength{\ptgap}
\setlength{\ptgap}{2em}

% The `\ptind` command is short for `\hspace{\ptgap}`.
\newcommand*{\ptind}{%
	\@ifstar{%
		\@ptindStar
	}{%
		\@ptindNoStar
	}
}

% Helper functions for `\ptind` and `\ptind*`.
\newcommand*{\@ptindStar}{\hspace*{\ptgap}}
\newcommand*{\@ptindNoStar}{\hspace{\ptgap}}

% The length, `\ptspacergap` is the length to indent stanza spacers by.
\newlength{\ptspacergap}
\setlength{\ptspacergap}{4em}

% Define the character to use for a spacer (defaults to a section mark).
\newcommand*{\ptspacerchar}{\S}

% The `\ptspacer` command prints `\ptspacerchar` 3 times indented by `\ptspacergap`.
\newcommand*{\ptspacer}{%
  \@ifstar{%
    \@ptspacerStar
  }{%
    \@ptspacerNoStar
  }
}

% Helper functions for `\ptspacer` and `\ptspacer*`.
\newcommand*{\@ptspacerStar}{\hspace*{\ptspacergap}\ptspacerchar\ptspacerchar\ptspacerchar}
\newcommand*{\@ptspacerNoStar}{\hspace{\ptspacergap}\ptspacerchar\ptspacerchar\ptspacerchar}
